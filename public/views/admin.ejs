
<!DOCTYPE html>
<!--
This is a starter template page. Use this page to start your new project from
scratch. This page gets rid of all links and provides the needed markup only.
-->
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Loyalty Card Scanner Admin</title>

  <!-- Google Font: Source Sans Pro -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="../ui/plugins/fontawesome-free/css/all.min.css">
  <!-- Theme style -->

   <!-- Toastr -->
   <link rel="stylesheet" href="../ui/plugins/toastr/toastr.min.css">
  <link rel="stylesheet" href="../ui/dist/css/adminlte.min.css">
</head>
<body class="hold-transition layout-top-nav">
<div class="wrapper">

  <!-- Navbar -->
  <nav class="main-header navbar navbar-expand-md navbar-light navbar-white">
    <div class="container">
      <a href="" class="navbar-brand">
        <!-- <img src="../ui/dist/img/AdminLTELogo.png" alt="AdminLTE Logo" class="brand-image img-circle elevation-3" style="opacity: .8"> -->
        <span class="brand-text font-weight-light">Linan Mountain View Resort </span>
      </a>

      <button class="navbar-toggler order-1" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

  
    
    </div>
  </nav>
  <!-- /.navbar -->

  <!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <div class="content-header  mb-0 pb-0">
      <div class="container mb-0">
        <div class="row ">
          <div class="col-sm-6">
            <h1 class="m-0">Loyalty Card Scanner</h1>
          </div><!-- /.col -->
       
        </div><!-- /.row -->
      </div><!-- /.container-fluid -->
    </div>
    <!-- /.content-header -->

    <!-- Main content -->
    <div class="content">
      <div class="container">
        <div class="row mb-0">
         
          <!-- /.col-md-6 -->
          <!-- <div class="col-lg-6">


            <div class="card card-primary card-outline">
              <div class="card-header">
                <h5 class="card-title m-0">Featured</h5>
              </div>
              <div class="card-body">
                <h6 class="card-title">Special title treatment</h6>

                <p class="card-text">With supporting text below as a natural lead-in to additional content.</p>
                <a href="#" class="btn btn-primary">Go somewhere</a>
              </div>
            </div>
          </div> -->
          <!-- /.col-md-6 -->
        </div>
        <!-- /.row -->

        <div class="row ">
           <style>
            video{
              width: 50%;
              position: relative;
              left: 25%;
              /* height: 50%; */
            }
           </style>

                <div class="d-flex justify-content-center align-items-center">
                  <div id="video-container">
                    <video id="qr-video"></video>
                      <div class="col-md-10">

                      </div>
                  </div>

                </div>

                <div class="col-md-12">
                  <div class="card">
                    <div class="card-header">
                      <h3 class="card-title">Transaction History</h3>
                    </div>
                    <!-- /.card-header -->
                    <div class="card-body p-0">
                      <table class="table table-striped">
                        <thead>
                          <tr>
                            <th>Name</th>
                            <th>Product / Service</th>
                            <th>Amount</th>
                            <th>Transaction Date</th>
                          </tr>
                        </thead>
                        <tbody id="tbody">
                        
                        </tbody>
                      </table>
                    </div>
                    <!-- /.card-body -->
                  </div>
                </div>
              
                
                <div class="d-none">
                  <div>
                    <label>
                        Highlight Style
                        <select id="scan-region-highlight-style-select">
                            <option value="default-style">Default style</option>
                            <option value="example-style-1">Example custom style 1</option>
                            <option value="example-style-2">Example custom style 2</option>
                        </select>
                    </label>
                    <label>
                        <input id="show-scan-region" type="checkbox">
                        Show scan region canvas
                    </label>
                </div>
                <div>
                    <select id="inversion-mode-select">
                        <option value="original">Scan original (dark QR code on bright background)</option>
                        <option value="invert">Scan with inverted colors (bright QR code on dark background)</option>
                        <option value="both">Scan both</option>
                    </select>
                    <br>
                </div>
                <b>Device has camera: </b>
                <span id="cam-has-camera"></span>
                <br>
                <div>
                    <b>Preferred camera:</b>
                    <select id="cam-list">
                        <option value="environment" selected>Environment Facing (default)</option>
                        <option value="user">User Facing</option>
                    </select>
                </div>
                <b>Camera has flash: </b>
                <span id="cam-has-flash"></span>
                <div>
                    <button id="flash-toggle">ðŸ“¸ Flash: <span id="flash-state">off</span></button>
                </div>
                <br>
                <b>Detected QR code: </b>
                <span id="cam-qr-result">None</span>
                <br>
                <b>Last detected at: </b>
                <span id="cam-qr-result-timestamp"></span>
                <br>
                <button id="start-button">Start</button>
                <button id="stop-button">Stop</button>
                <hr>

                <h1>Scan from File:</h1>
                <input type="file" id="file-selector">
                <b>Detected QR code: </b>
                <span id="file-qr-result">None</span>
                </div>

                
            

        </div>
      </div><!-- /.container-fluid -->
    </div>
    <!-- /.content -->
  </div>
  <!-- /.content-wrapper -->

  <!-- Control Sidebar -->
  <aside class="control-sidebar control-sidebar-dark">
    <!-- Control sidebar content goes here -->
  </aside>
  <!-- /.control-sidebar -->

  <!-- Main Footer -->
  <footer class="main-footer">
    <!-- To the right -->
    <div class="float-right d-none d-sm-inline">
      All rights reserved.
    </div>
    <!-- Default to the left -->
    <strong>Copyright &copy; 2022 Linan Mountain View Resort       </strong>  
  </footer>
</div>
<!-- ./wrapper -->

<!-- REQUIRED SCRIPTS -->


<div class="modal fade" id="modal-default"  data-keyboard="false" data-backdrop="static">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title">Transaction form</h4>
        <!-- <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button> -->
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Name</label>
          <h4>Sample</h4>
          <label>Birthdate</label>
          <h4>12-12-200</h4>
          <label>Address</label>
          <h4>Tupi South Cotabato</h4>
          <label for="">Product / Service</label>
          <form id="pay">
            <textarea class="form-control" rows="2" id="product_service" name="product_service" required placeholder="Enter Product/Service ..."></textarea>
            <label for="">Amount</label>
            <input type="number" class="form-control" id="amount" name="amount" required placeholder="Enter Amount...">
          </div>
          
        </div>
        <div class="modal-footer justify-content-between">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-success"> <i class="fas fa-save"></i> Pay</button>
        </form>
      </div>
    </div>
    <!-- /.modal-content -->
  </div>
  <!-- /.modal-dialog -->
</div>
<!-- /.modal -->


<!-- jQuery -->
<script src="../ui/plugins/jquery/jquery.min.js"></script>
<!-- Bootstrap 4 -->
<script src="../ui/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
<!-- Toastr -->
<script src="../ui/plugins/toastr/toastr.min.js"></script>
<!-- AdminLTE App -->
<script src="../ui/dist/js/adminlte.min.js"></script>

 <script>

loadData()
    setInterval(() => {
        loadData()
    }, 3000);

function loadData(params) {
    $.getJSON("/transactions/1",
        function (data, textStatus, jqXHR) {
           let str = ""
             data.forEach(e => {
                str += `
                <tr>
                  <td>${e.name}</td>
                    <td>${e.product_service}</td>
                    <td class=""> <span class="badge bg-success">${e.amount}</span>  </td>
                    <td>${e.payment_at}</td>
                </tr>
                `
             });

        $("#tbody").html(str);
        //  console.log(data[0]);
        }
    );
    
}


  var prev = "";

   $("#pay").submit(function (e) { 
    e.preventDefault();

     let form =  $( this ).serialize();
    const data = Object.fromEntries(new FormData(e.target).entries());
       console.log(data)
        
       console.log($("#amount").val(),$("#product_service").val());
        
        // return
    if (confirm("Sure about the details ?")) {
       
      $.ajax({
        type: "POST",
        url: "/transactions",
        data: form,
        dataType: 'json',
        success: function (res) {

          if (res) {
            prev = "";
            $("#modal-default").modal('toggle');
            $("#pay").trigger('reset');


            $(document).Toasts('create', {
              class: 'bg-success',
              title: 'Success !',
              body: 'Your transaction is Successful'
            })
          }

        }
      });
      
    
      
      // validation for  if scan again qr
      
    }
      
   });


 </script>


<script type="module">
  import QrScanner from "../demo/qr-scanner.min.js";

  const video = document.getElementById('qr-video');
  const videoContainer = document.getElementById('video-container');
  const camHasCamera = document.getElementById('cam-has-camera');
  const camList = document.getElementById('cam-list');
  const camHasFlash = document.getElementById('cam-has-flash');
  const flashToggle = document.getElementById('flash-toggle');
  const flashState = document.getElementById('flash-state');
  const camQrResult = document.getElementById('cam-qr-result');
  const camQrResultTimestamp = document.getElementById('cam-qr-result-timestamp');
  const fileSelector = document.getElementById('file-selector');
  const fileQrResult = document.getElementById('file-qr-result');
   


  function setResult(label, result) {
      console.log(result.data);
      
       if (result.data != prev) {
        prev  = result.data;
        // console.log(`${result.data} != ${prev}`);
        // console.log(typeof prev);
        
        // FETCH DATA  DISPLAY USER  INFO
          $.getJSON(`/users/${result.data}`,
            function (data, textStatus, jqXHR) {
              console.log(data);
              console.log(data.length);
              if (data.length != 0) {
                  $("#modal-default").modal('toggle');
              }else{
                $(document).Toasts('create', {
                  class: 'bg-danger',
                  title: 'Failed',
                  body: `Loyalty Card Owner doesn't exist`
                })
              }
            }
          );
       }

      label.textContent = result.data;
      camQrResultTimestamp.textContent = new Date().toString();
      label.style.color = 'teal';
      clearTimeout(label.highlightTimeout);
      label.highlightTimeout = setTimeout(() => label.style.color = 'inherit', 100);
  }

  // ####### Web Cam Scanning #######

  const scanner = new QrScanner(video, result => setResult(camQrResult, result), {
      onDecodeError: error => {
          camQrResult.textContent = error;
          camQrResult.style.color = 'inherit';
      },
      highlightScanRegion: true,
      highlightCodeOutline: true,
  });

  const updateFlashAvailability = () => {
      scanner.hasFlash().then(hasFlash => {
          camHasFlash.textContent = hasFlash;
          flashToggle.style.display = hasFlash ? 'inline-block' : 'none';
      });
  };

  scanner.start().then(() => {
      updateFlashAvailability();
      // List cameras after the scanner started to avoid listCamera's stream and the scanner's stream being requested
      // at the same time which can result in listCamera's unconstrained stream also being offered to the scanner.
      // Note that we can also start the scanner after listCameras, we just have it this way around in the demo to
      // start the scanner earlier.
      QrScanner.listCameras(true).then(cameras => cameras.forEach(camera => {
          const option = document.createElement('option');
          option.value = camera.id;
          option.text = camera.label;
          camList.add(option);
      }));
  });

  QrScanner.hasCamera().then(hasCamera => camHasCamera.textContent = hasCamera);

  // for debugging
  window.scanner = scanner;

  document.getElementById('scan-region-highlight-style-select').addEventListener('change', (e) => {
      videoContainer.className = e.target.value;
      scanner._updateOverlay(); // reposition the highlight because style 2 sets position: relative
  });

  document.getElementById('show-scan-region').addEventListener('change', (e) => {
      const input = e.target;
      const label = input.parentNode;
      label.parentNode.insertBefore(scanner.$canvas, label.nextSibling);
      scanner.$canvas.style.display = input.checked ? 'block' : 'none';
  });

  document.getElementById('inversion-mode-select').addEventListener('change', event => {
      scanner.setInversionMode(event.target.value);
  });

  camList.addEventListener('change', event => {
      scanner.setCamera(event.target.value).then(updateFlashAvailability);
  });

  flashToggle.addEventListener('click', () => {
      scanner.toggleFlash().then(() => flashState.textContent = scanner.isFlashOn() ? 'on' : 'off');
  });

  document.getElementById('start-button').addEventListener('click', () => {
      scanner.start();
  });

  document.getElementById('stop-button').addEventListener('click', () => {
      scanner.stop();
  });

  // ####### File Scanning #######

  fileSelector.addEventListener('change', event => {
      const file = fileSelector.files[0];
      if (!file) {
          return;
      }
      QrScanner.scanImage(file, { returnDetailedScanResult: true })
          .then(result => setResult(fileQrResult, result))
          .catch(e => setResult(fileQrResult, { data: e || 'No QR code found.' }));
  });
</script>

<style>
  div {
      margin-bottom: 16px;
  }

  #video-container {
      line-height: 0;
  }

  #video-container.example-style-1 .scan-region-highlight-svg,
  #video-container.example-style-1 .code-outline-highlight {
      stroke: #64a2f3 !important;
  }

  #video-container.example-style-2 {
      position: absolute;
      width: 50px;
      height: 100%;
      overflow: hidden;
  }
  #video-container.example-style-2 .scan-region-highlight {
      border-radius: 30px;
      outline: rgba(0, 0, 0, .25) solid 50vmax;
  }
  #video-container.example-style-2 .scan-region-highlight-svg {
      display: none;
  }
  #video-container.example-style-2 .code-outline-highlight {
      stroke: rgba(255, 255, 255, .5) !important;
      stroke-width: 15 !important;
      stroke-dasharray: none !important;
  }

  #flash-toggle {
      display: none;
  }

  hr {
      margin-top: 32px;
  }
  input[type="file"] {
      display: block;
      margin-bottom: 16px;
  }
</style>

</body>
</html>
